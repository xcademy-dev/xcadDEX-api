# XCADDEX-API

API server for XCAD DEX

## Setup
You will need to have the following installed
1. Rust:

https://www.rust-lang.org/tools/install

2. Diesel ORM for PostgreSQL database
```Diesel
cargo install diesel_cli --no-default-features --features postgres
```

More info here https://diesel.rs/guides/getting-started

3. PostgreSQL database

https://www.postgresql.org/download/

4. Redis Database

https://developer.redis.com/create


## Creating / Migrating Database

You will need Postgresql installed.

```bash
diesel setup
```
or
```bash
 diesel migration run
```

diesel setup will create the database for you if it does not exist.

Use pgAdmin to check the result of this operation.

You should have the database and a numbers of tables created.

## .env settings

Configure your env vars by setting them in the .env file at the root of the binary, as part of the shell profile, or in the run command:

You will need:

    A connection to a Redis database
    A connection the the PostgreSQL database
    API key and secret from Viewblock.io
    Select Testnet or Mainnet
    Select WORKER process true/false, this process retrieves DEX data from Viewblock.io and save to PostgreSQL database

There is a flag that controll the Distribution process of generating the Merkletree.

To enable Merkletree creation set the flag RUN_GENERATE to true

```env
BIND=127.0.0.1:3000
REDIS_URL=redis://127.0.0.1:6379
DATABASE_URL=postgresql://USER:PASSWORDd@localhost:5432/xcaddex-api
VIEWBLOCK_API_KEY=xxxxx
VIEWBLOCK_API_SECRET=yyyyy
RUN_WORKER=true|false
NETWORK=mainnet|testnet
RUN_GENERATE=true|false
```

## Running

The executable generated by this Rust code has to parts

1. The Worker Process

    The Worker process is designed to connect to the Viewblock API to retrieve the required data from the DEX
    
    For this to work a viewblock Api key and secret setting has to be set in the .env file
    
2. The Web Service

Make sure to have required settings in .env file

Run the server with:

```rust
cargo run
```

The web service exposes these end points

#[get("/")]

#[get("/swaps")]

#[get("/liquidity_changes")]

#[get("/volume")]

#[get("/transactions")]

#[get("/liquidity")]

#[get("/weighted_liquidity")]

#[get("distribution/generate/{id}")]

#[get("/distribution/info")]

#[get("/distribution/estimated_amounts/{user_address}")]

#[get("/distribution/data/{distributor_address}/{epoch_number}")]

#[get("/distribution/claimable_data/{user_address}")]

#[get("/claims")]


## Building

You will need Rust (stable) installed.

```rust
cargo build
```


## Deployment

1. Build new binary for Linux:

    `cargo build --release` on a Linux machine (or host node, src can be found in ~/src/xcaddex-api)

    The built binary can be found in `./target/release/xcaddex-api`. Transfer this to `/opt/xcaddex-api-<testnet|mainnet>`

2. Stop old node process:

    `sudo systemctl stop xcaddex-api-<testnet|mainnet>`

3. Run migrations:

    `diesel migration run`

4. Run new node by restarting systemd (make sure env vars are correct in run command / .env file):

    `sudo systemctl start xcaddex-api-<testnet|mainnet>`
